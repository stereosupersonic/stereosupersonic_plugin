
  namespace :svn do
    def application
      APPLICATION
    end
    def svn_path
      "http://stereosonic@svn.foosong.com/ruby/rails-projects/"
    end
    
    def application
      RAILS_ROOT.split(/\//).last
    end

    def trunk_path
      "#{svn_path}/#{application}/trunk"
    end

    def production_path
      "#{svn_path}/#{application}/branches/production"
    end

    def tmp_dir
      "/tmp/foo"
    end

    def checkout
      File.join(tmp_dir,application)
    end

    def cleanup
      rm_r(tmp_dir, :force => true)
    end

    def cap_production_deploy
      sh "cap production deploy:migrations"
    end

    def delete_production_branch
      sh "svn del #{production_path} -m 'delete #{application} production branch'"    
    end

    def copy_trunk_to_production
      sh "svn cp #{trunk_path} #{production_path} -m 'production push #{application} #{Time.now.strftime '%d.%m.%Y %H:%M'}'"
    end
    
    def create_new_branch(branch_name)
       #TODO
       sh "svn cp #{trunk_path} #{production_path} -m 'production push #{application} #{Time.now.strftime '%d.%m.%Y %H:%M'}'"
     end

    desc "Pushes the trunk to production"
    task :push do              
      delete_production_branch       
      copy_trunk_to_production
      cap_production_deploy
    end

    desc "Cherry Pick. Example: rake svn:pick[\"8625 8626\"]"
    task:pick, [:revisions]  do |t, args|
      raise "keine Revisions angegeben. Beispiel: rake svn:pick[\"8625 8626\"]" unless args.revisions
      revs = args.revisions.split(/;|,|\W/)
      raise "keine Revisions angegeben in #{revs}" if revs.empty?
      checkout_production
      puts "start merge #{revs}"
      Dir.chdir(checkout)
      sh "svn merge -c #{revs.join(',')} #{trunk_path}"
      sh "svn ci -m 'cp #{revs.join(',')} #{Time.now.strftime '%d.%m.%Y %H:%M'}' "
      cap_production_deploy
      cleanup
    end
  end
